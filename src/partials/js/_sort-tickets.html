<script>
  const TITO_SECTIONS = [
    { title: 'Combo tickets', keywords: ['combo'] },
    { title: 'Remote', keywords: ['remote attendance'], additionalKeywords: ['combo'] },
    { title: 'Workshops', keywords: ['workshop:', 'workshop pass'] },
    { title: 'Other', keywords: [] },
  ];

  function sortTicketsInWidget(widget) {
    const availableTickets = Array.from(widget.querySelectorAll('.tito-release:not(.tito-release--sold-out)'));
    const multipassBlock = document.querySelector('.js-multipass-intro-tito');
    const widgetFormBlock = document.querySelector('.tito-widget-form > div');

    widget.querySelectorAll('.tito-release').forEach(ticket => {
      const titleElement = ticket.querySelector('.tito-release--title');
      if (titleElement) {
        titleElement.innerText = titleElement.innerText.replace(/^Hybrid Attendance:\s*/i, '');
      }

      const ticketTitle = getTicketTitle(ticket);
      if (ticketTitle.includes('multipass')) {
        ticket.classList.add('multipass-ticket');
      }

    });

    if (!availableTickets.length) return;

    let remainingTickets = availableTickets;

    TITO_SECTIONS.forEach((section, index) => {
      const sectionId = generateSectionId(section.title, widget);
      const filteredTickets = section.title === 'Other'
        ? remainingTickets
        : filterTicketsByKeywords(remainingTickets, section);

      remainingTickets = remainingTickets.filter(ticket => !filteredTickets.includes(ticket));

      const sectionElement = widget.querySelector(`#${sectionId}`);
      if (filteredTickets.length) {
        if (!sectionElement) {
          createTicketSection(section.title, index + 2, widget);
        }

        assignTicketOrder(filteredTickets, index + 2);

        // Add multipass block if needed
        if (multipassBlock) {
          if (section.title === 'Remote') {
            multipassBlock.style.order = index + 2;
            multipassBlock.remove();
            widgetFormBlock.insertBefore(multipassBlock, widgetFormBlock.children[2]);
          } else if (section.title === 'Other' && !widget.querySelector('#remote')) {
            multipassBlock.style.order = index + 2;
            multipassBlock.remove();
            widgetFormBlock.insertBefore(multipassBlock, widgetFormBlock.children[2]);
          }
        }

      } else if (sectionElement) {
        removeTicketSection(section.title, widget);
      }
    });


  }


  function filterTicketsByKeywords(tickets, section) {
    if (section.keywords.length === 0) return tickets;

    return tickets.filter(ticket => {
      let ticketTitle = getTicketTitle(ticket);

      const hasKeyword = section.keywords.some(keyword => ticketTitle.toLowerCase().includes(keyword.toLowerCase()));
      const hasAdditionalKeyword = section.additionalKeywords
        ? section.additionalKeywords.some(keyword => ticketTitle.toLowerCase().includes(keyword.toLowerCase()))
        : false;

      if (section.title === 'Combo tickets' && ticketTitle.toLowerCase().includes('remote attendance')) {
        return false;
      }

      if (ticketTitle.toLowerCase().includes('workshop pass')) {
        ticket.setAttribute('data-anchor', 'workshop-pass');
      }

      return hasKeyword || (hasAdditionalKeyword && hasKeyword);
    });
  }

  function getTicketTitle(ticket) {
    return ticket.querySelector('.tito-release--title').innerText.toLowerCase();
  }

  function generateSectionId(title, widget) {
    return `${title.toLowerCase().replace(/\s+/g, '-')}`;
  }

  function createTicketSection(title, order, widget) {
    const sectionHtml = `
      <section class="tito-section" id="${generateSectionId(title, widget)}" style="order: ${order}">
        <h3 class="tito-section__title">${title}</h3>
      </section>
    `;
    widget.querySelector('div:first-child').insertAdjacentHTML('afterbegin', sectionHtml);
  }

  function assignTicketOrder(tickets, order) {
    tickets.forEach(ticket => {
      ticket.style.order = order;
    });
  }

  function removeTicketSection(title, widget) {
    const section = widget.querySelector(`#${generateSectionId(title, widget)}`);
    if (section) section.remove();
  }

  function sortTicketsForAllWidgets() {
    const widgets = document.querySelectorAll('.tito-widget-form');
    widgets.forEach(widget => {
      sortTicketsInWidget(widget);
    });
  }

  function scrollToHash() {
    const hash = window.location.hash;
    if (hash) {
      const target = document.querySelector(hash);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth' });
      }
    }
  }

  function enhanceTicketDescriptions() {
    document.querySelectorAll('.tito-release-description--description').forEach((desc) => {
      const hrElement = desc.querySelector('hr');

      if (hrElement) {
        hrElement.style.display = 'none';

        // get all content after <hr>
        let nextElements = [];
        let sibling = hrElement.nextSibling;
        while (sibling) {
          nextElements.push(sibling);
          sibling = sibling.nextSibling;
        }


        if (nextElements.length > 0) {
          const icon = `<svg xmlns="http://www.w3.org/2000/svg" width="8" height="5" viewBox="0 0 8 5" fill="none">
            <path d="M3.996 4.49275C3.9436 4.49333 3.89163 4.48396 3.84346 4.46524C3.79529 4.44652 3.75196 4.41887 3.71628 4.38406L0.11988 1.12319C-0.03996 0.978261 -0.03996 0.753623 0.11988 0.608696C0.27972 0.463768 0.527472 0.463768 0.687313 0.608696L4.004 3.61594L7.31269 0.615942C7.47253 0.471014 7.72028 0.471014 7.88012 0.615942C8.03996 0.76087 8.03996 0.985507 7.88012 1.13043L4.28372 4.3913C4.2038 4.46377 4.0999 4.5 4.004 4.5L3.996 4.49275Z" /></svg>`;
          const spoiler = document.createElement('div');
          spoiler.className = 'tito-spoiler-content';
          spoiler.style.display = 'none';

          nextElements.forEach(el => spoiler.appendChild(el));

          hrElement.parentNode.appendChild(spoiler);

          const toggleButton = document.createElement('a');
          toggleButton.href = '#';
          toggleButton.className = 'tito-spoiler-toggle';
          toggleButton.innerHTML = `More details ${icon}`;

          toggleButton.addEventListener('click', (event) => {
            event.preventDefault();
            const isHidden = spoiler.style.display === 'none';
            spoiler.style.display = isHidden ? 'block' : 'none';
            toggleButton.innerHTML = isHidden ? `Hide details ${icon}` : `More details ${icon}`;
            toggleButton.classList.toggle('is-active', isHidden);
          });

          spoiler.parentNode.appendChild(toggleButton);
        }
      }
    });

  }

  tito('on:widget:loaded', function () {
    sortTicketsForAllWidgets();
    enhanceTicketDescriptions();
    scrollToHash();

  });

</script>