<script>
  const PORTAL_USER_DATA_LS_KEY = 'portal_user_data';

  window.tito =
    window.tito ||
    function () {
      (tito.q = tito.q || []).push(arguments);
    };

  const emailForm = createEmailFormModalController();

  tito('on:widget:loaded', function () {
    persistPortalUserData().then(() => {
      const userData = getPersistedPortalUserData();

      if (userData) {
        prefillTitoForm(userData);
        trackThrottled(userData);
      } else {
        emailForm.show();
      }
    });
  });

  function prefillTitoForm(data) {
    const titoWidgets = document.querySelectorAll('tito-widget');

    for (const widget of titoWidgets) {
      widget.setAttribute('prefill', JSON.stringify({ email: data.email }));
    }
  }

  function persistPortalUserData() {
    if (getPersistedPortalUserData()) {
      return Promise.resolve();
    }

    return fetchPortalUserData().then((data) => {
      if (data) {
        persistUserDataToStorage(data);
      }
    });
  }

  function persistUserDataToStorage(userData) {
    localStorage.setItem(PORTAL_USER_DATA_LS_KEY, JSON.stringify(userData));
  }

  function updatePersistedUserField(field, value) {
    const userData = getPersistedPortalUserData() || {};
    userData[field] = value;
    persistUserDataToStorage(userData);
  }

  function getPersistedPortalUserData() {
    try {
      const parsedData = JSON.parse(localStorage.getItem(PORTAL_USER_DATA_LS_KEY));
      const isValid = validateUserData(parsedData);

      if (!isValid) throw new Error();

      return parsedData;
    } catch {
      return null;
    }
  }

  function validateUserData(data) {
    if (!data || !data.email || typeof data.email !== 'string' || !data.email.length) return false;

    return true;
  }

  function fetchPortalUserData() {
    const url = `${BASE_URL}/api/me`;

    return fetch(url, {
      credentials: 'include',
    })
      .then((res) => {
        if (!res.ok) {
          return reject(res.statusText);
        }

        return res.json();
      })
      .catch((error) => {
        console.log(error);

        return null;
      });
  }

  function createEmailFormModalController() {
    const selector = '.checkout-container__modal';
    const visibilityClass = 'show-modal';
    const modal = document.querySelector(selector);
    const form = modal.querySelector('form');
    const emailInput = modal.querySelector('input[type="email"]');
    const submitButton = modal.querySelector('button[type="submit"]');

    const updateButtonState = () => (submitButton.disabled = !form.checkValidity());

    const show = () => {
      if (!modal) return;

      modal.classList.add(visibilityClass);
    };

    const hide = () => {
      if (!modal) return;

      modal.classList.remove(visibilityClass);
    };

    form.addEventListener('input', updateButtonState);
    form.addEventListener('change', updateButtonState);
    submitButton.addEventListener('click', function (e) {
      e.preventDefault();

      const email = emailInput.value.trim();

      if (email) {
        updatePersistedUserField('email', email);
        hide();

        const userData = getPersistedPortalUserData();

        if (userData) {
          prefillTitoForm(userData);
          trackThrottled(userData);
        }
      }
    });

    updateButtonState();

    return { show, hide };
  }
</script>
