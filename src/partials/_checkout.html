<div class="section sec-checkout" style="--bgColor: {{ emsBrand.backgroundCSS }}; --textColor: {{ emsBrand.textColor }}; --accentColor: {{ emsBrand.accentCSS }}">
  <div class="container">
    {% if pagesPieceOfTexts.checkout__title %}
    <h3 class="sec-checkout__title">{{ mixins.text(pieceOfTexts, 'checkout__title') }}</h3>
    {% endif %}

    {% if pagesPieceOfTexts.checkout__description %}
    <div class="sec-checkout__description">
      {{ mixins.text(pieceOfTexts, 'checkout__description') }}
    </div>
    {% endif %}

    <script src='https://js.tito.io/v2/with/inline,ga4,facebook' async></script>

    <div class="tito-wrapper js-tabs-container">
      {% if pages[pageKey].pageSections.checkout.remote %}
      <div class="checkout-tabs">
        <button data-href="#checkout-hybrid" class="checkout-tabs__item js-tab-link" data-tab="1">
          {{ pages[pageKey].pageSections.checkout.default.text }}
        </button>
        <button data-href="#checkout-remote" class="checkout-tabs__item js-tab-link" data-tab="2">
          {{ pages[pageKey].pageSections.checkout.remote.text }}
        </button>
      </div>
      <div class="checkout-tab js-tab is-active" data-tab="1">
        <div class="tito-block">
          <tito-widget event="{{ pages[pageKey].pageSections.checkout.default.link }}"></tito-widget>
        </div>

        {% if pagesPieceOfTexts.checkout__bottomText %}
        <div class="tito-wrapper__text">
          {{ pagesPieceOfTexts.checkout__bottomText }} <a target="_blank" href="https://ti.to/{{ pages[pageKey].pageSections.checkout.default.link }}">{{ pagesPieceOfTexts.checkout__bottomLink }}</a>
        </div>

        {% endif %}
      </div>

      <div class="checkout-tab js-tab is-active" data-tab="2">
        <div class="tito-block js-tab" data-tab="2">
          <tito-widget event="{{ pages[pageKey].pageSections.checkout.remote.link }}"></tito-widget>
        </div>
        {% if pagesPieceOfTexts.checkout__bottomText %}
        <div class="tito-wrapper__text">
          {{ pagesPieceOfTexts.checkout__bottomText }} <a target="_blank" href="https://ti.to/{{ pages[pageKey].pageSections.checkout.remote.link }}">{{ pagesPieceOfTexts.checkout__bottomLink }}</a>
        </div>

        {% endif %}

      </div>
      {% else %}
      <div class="tito-block ">
        <tito-widget event="{{ pages[pageKey].pageSections.checkout.default.link }}"></tito-widget>
      </div>

      {% if pagesPieceOfTexts.checkout__bottomText %}
      <div class="tito-wrapper__text">
        {{ pagesPieceOfTexts.checkout__bottomText }} <a target="_blank" href="https://ti.to/{{ pages[pageKey].pageSections.checkout.default.link }}">{{ pagesPieceOfTexts.checkout__bottomLink }}</a>
      </div>
      {% endif %}
      {% endif %}

    </div>
  </div>
</div>

<script>
  const FORM_CHECK_INTERVAL = 500;
  const BASE_URL = 'https://portal.gitnation.org';
  // const BASE_URL = 'http://localhost:3000';

  let state = {};
  async function updateState(values) {
    state = { ...state, ...values };

    if (state.tickets.length > 0 && (state.email || (state.name && state.company))) {
      trackRequest(state);
    }
  }

  async function trackRequest(data) {
    return fetch(BASE_URL + '/api/order/track', { body: JSON.stringify(data), method: 'POST' }).then(response => response.json());
  }

  async function completeRequest(data) {
    return fetch(BASE_URL + '/api/order/complete', { body: JSON.stringify(data), method: 'POST' }).then(response => response.json());
  }

  /**
   * @param {string} selector
   * @param {string} stateField
   */
  function trackField(selector, stateField) {
    const field = document.querySelector(selector);
    if (field) {
      field.addEventListener('blur', (e) => {
        const value = e.target.value;
        if (state[stateField] !== value) {
          updateState({ [stateField]: e.target.value });
        }
      })
    }
  }

  function waitForm() {
    let waitTime = FORM_CHECK_INTERVAL * 10;

    return new Promise((resolve, reject) => {
      const interval = setInterval(() => {
        const form = document.querySelector('form[class="tito-registration-form"]');
        if (form) {
          clearInterval(interval);
          resolve();
        }

        waitTime -= FORM_CHECK_INTERVAL;
        if (waitTime <= 0) {
          clearInterval(interval);
          reject(new Error('Timeout'));
        }
      }, FORM_CHECK_INTERVAL)
    })
  }

  /**
   * @typedef Event
   * @type {object}
   * @property {string} slug
   * @property {string} title
   *
   * @typedef LineItem
   * @type {object}
   * @property {string} release_slug
   * @property {string} release_title
   * @property {number} quantity
   *
   * @typedef TitoData
   * @type {object}
   * @property {string} slug
   * @property {string} email
   * @property {string} company_name
   * @property {string} name
   * @property {Event} event
   * @property {LineItem[]} line_items
  */

  /**
   * @param {TitoData} initialData - parameter from `on:registration:started` hook
   */
  window.initTitoHandlers = window.initTitoHandlers || function (initialData = {}) {
    waitForm().then(() => {
      console.debug('init handlers');
      state = {};

      trackField('input[id="tito-name"]', 'name');
      trackField('input[id="tito-email"]', 'email');
      trackField('input[id="tito-company-name"]', 'company');

      updateState({
        orderId: initialData.slug,
        name: initialData.name,
        company: initialData.company_name,
        email: initialData.email,
        eventSlug: initialData.event.slug,
        tickets: initialData.line_items.map(i => ({ title: i.release_title, quantity: i.quantity }))
      })
    })
  }

  window.finishTitoRegistration = window.finishTitoRegistration || function () {
    console.debug('finish tito registration');
    completeRequest(state);
  }
</script>